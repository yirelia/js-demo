<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>router</title>
    <link rel="stylesheet" href="../css/index.css" />
    <script src="../js/x6/2.18.1/index.js"></script>
  </head>

  <body>
    <div id="app"></div>
  </body>
  <script type="module">
    /**
     *  计算两点之间的正交路由, 不考虑盒子的大小
     *
     * 例如:
     * point1 = { x: 0, y: 0 }
     * point2 = { x: 100, y: 100 }
     *
     *
     *
     **/
    import orth from "../js/orth/point.js";
    import { Rectangle } from "../js/common/rect.js";
    const graph = new X6.Graph({
      container: document.getElementById("app"),
      grid: true,
      background: {
        color: "#f0f0f0",
      },
    });

    let line;



    const rect1 = new Rectangle(10, 10, 50, 50);
    const rect2 = new Rectangle(40, 40, 50, 50);

    const source = graph.addNode({
      id: `source`,
      x: 100,
      y: 100,
      width: 100,
      height: 40,
      label: "source",
    });

    const target = source
      .clone()
      .translate(100, 100).setAttrByPath("id", "target")
      .setAttrByPath("label/text", "target");
      graph.addNode(target)

    let sourcePoint = source.getBBox().center;

    let targetPoint = target.getBBox().center;



    function drawLine(sourcePoint, targetPoint) {
      const bearing = orth.getBearing(sourcePoint, targetPoint);
      let result = [];
      if (!bearing) {
        const route = orth.pointToPoint(sourcePoint, targetPoint);
        result.push(...route.points);
      }

      const paths = [sourcePoint, ...result, targetPoint];

      const findPath = (paths) => {
        let pathString = `M ${paths[0].x} ${paths[0].y}`;
        for (let index = 1; index < paths.length; index++) {
          pathString += ` L ${paths[index].x} ${paths[index].y}`;
        }
        return pathString;
      };

      const pathData = findPath(paths);
      if(!line) {
        line = graph.addNode({
        shape: "path",
        vertices: paths,
        attrs: {
          body: {
            d: pathData,
            stroke: "red",
          },
        },
      });
      } else {
        line.setAttrByPath('body/d', pathData)
      }

    }

    drawLine(sourcePoint, targetPoint);
    source.on('change:position', ({cell}) => {
        const sourcePoint = cell.getBBox().center;
        const targetPoint = target.getBBox().center;
        drawLine(sourcePoint, targetPoint);
    })

    target.on('change:position', ({cell}) => {
        const sourcePoint = source.getBBox().center;
        const targetPoint = cell.getBBox().center;
        drawLine(sourcePoint, targetPoint);
    })
  </script>
</html>
